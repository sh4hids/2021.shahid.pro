{"componentChunkName":"component---node-modules-sh-4-hids-gatsby-theme-open-sourcerer-src-templates-post-js","path":"/blog/2024/01/07/completely-delete-objects-from-versioned-s-3-bucket/","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://v2021.shahid.pro","blogPath":"blog","baseEditUrl":"https://github.com/sh4hids/2021.shahid.pro/edit/main/contents/blog","utterancesCommentRepo":"sh4hids/shahid.pro-comments","author":{"fullName":"Shahidul Islam Majumder"}}},"markdownRemark":{"html":"<p>Recently, I was working on a feature where we needed to delete some files from S3. I followed some instructions from AWS SDK documentation and completed the feature. While testing the feature, I got a successful response. But when I checked the S3 bucket, deleted file was still there.</p>\n<p>So I did a little digging and found that our S3 bucket was a <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/userguide/Versioning.html\">versioning-enabled</a> bucket. In this type of S3 bucket <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/userguide/DeletingObjectVersions.html#delete-request-use-cases\">object does not get deleted on a simple delete request</a>. S3 adds a <code class=\"language-text\">Delete</code> marker in the bucket, and that marker becomes the current version of the object with a new ID. When someone tries to get the object, it will return 404, but it is still there.</p>\n<p>To delete a version-enabled file, first of all we have to fetch all the versions . Then we need to delete each version of the file by providing the version ID with the file key in the delete request. To complete the process, finally we have to delete the file with no version id.</p>\n<p>Let's check how we can do this using AWS TypeScript SDK.</p>\n<h2 id=\"aws-sdk-v2\" style=\"position:relative;\"><a href=\"#aws-sdk-v2\" aria-label=\"aws sdk v2 permalink\" class=\"header-anchor-icon before\"><svg version=\"1.1\" x=\"0px\" y=\"0px\" viewBox=\"0 0 162.656 162.656\" xml:space=\"preserve\" width=\"0.6em\" height=\"0.6em\" fill=\"#21AAE2\" stroke=\"#21AAE2\" stroke-width=\"0\"><path d=\"M151.764,10.894c-14.522-14.522-38.152-14.525-52.676-0.008l0.003,0.003L76.112,33.872l10.607,10.605l22.983-22.988 l-0.002-0.002c8.678-8.663,22.785-8.658,31.457,0.014c8.673,8.672,8.672,22.786,0,31.461l-34.486,34.484 c-4.201,4.202-9.787,6.516-15.729,6.516c-5.942,0-11.529-2.314-15.73-6.516L64.605,98.052c7.035,7.035,16.389,10.91,26.338,10.91 c9.949,0,19.303-3.875,26.335-10.91l34.487-34.484C166.284,49.043,166.284,25.413,151.764,10.894z\"></path> <path d=\"M52.96,141.162L52.96,141.162c-8.675,8.67-22.788,8.668-31.461-0.005c-8.673-8.675-8.673-22.791-0.001-31.465L55.98,75.21 c8.675-8.674,22.789-8.674,31.462,0L98.05,64.604c-14.524-14.523-38.154-14.524-52.676,0L10.89,99.086 c-14.519,14.523-14.519,38.154,0.001,52.678c7.263,7.262,16.801,10.893,26.341,10.892c9.536,0,19.074-3.629,26.333-10.887 l0.002-0.001l22.984-22.99l-10.608-10.606L52.96,141.162z\"></path> </svg></a>AWS SDK v2</h2>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> aws <span class=\"token keyword\">from</span> <span class=\"token string\">'aws-sdk'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> s3 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">aws</span><span class=\"token punctuation\">.</span><span class=\"token constant\">S3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">deleteObject</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>bucket<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> fileKey<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> Bucket<span class=\"token operator\">:</span> bucket<span class=\"token punctuation\">,</span> Prefix<span class=\"token operator\">:</span> fileKey <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> s3<span class=\"token punctuation\">.</span><span class=\"token function\">listObjectVersions</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>Versions<span class=\"token operator\">?.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> version <span class=\"token keyword\">of</span> response<span class=\"token punctuation\">.</span>Versions<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">await</span> s3\n        <span class=\"token punctuation\">.</span><span class=\"token function\">deleteObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n          Bucket<span class=\"token operator\">:</span> bucket<span class=\"token punctuation\">,</span>\n          Key<span class=\"token operator\">:</span> fileKey<span class=\"token punctuation\">,</span>\n          VersionId<span class=\"token operator\">:</span> version<span class=\"token punctuation\">.</span>VersionId<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> s3\n    <span class=\"token punctuation\">.</span><span class=\"token function\">deleteObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      Bucket<span class=\"token operator\">:</span> bucket<span class=\"token punctuation\">,</span>\n      Key<span class=\"token operator\">:</span> fileKey<span class=\"token punctuation\">,</span>\n      VersionId<span class=\"token operator\">:</span> <span class=\"token string\">'null'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"aws-sdk-v3\" style=\"position:relative;\"><a href=\"#aws-sdk-v3\" aria-label=\"aws sdk v3 permalink\" class=\"header-anchor-icon before\"><svg version=\"1.1\" x=\"0px\" y=\"0px\" viewBox=\"0 0 162.656 162.656\" xml:space=\"preserve\" width=\"0.6em\" height=\"0.6em\" fill=\"#21AAE2\" stroke=\"#21AAE2\" stroke-width=\"0\"><path d=\"M151.764,10.894c-14.522-14.522-38.152-14.525-52.676-0.008l0.003,0.003L76.112,33.872l10.607,10.605l22.983-22.988 l-0.002-0.002c8.678-8.663,22.785-8.658,31.457,0.014c8.673,8.672,8.672,22.786,0,31.461l-34.486,34.484 c-4.201,4.202-9.787,6.516-15.729,6.516c-5.942,0-11.529-2.314-15.73-6.516L64.605,98.052c7.035,7.035,16.389,10.91,26.338,10.91 c9.949,0,19.303-3.875,26.335-10.91l34.487-34.484C166.284,49.043,166.284,25.413,151.764,10.894z\"></path> <path d=\"M52.96,141.162L52.96,141.162c-8.675,8.67-22.788,8.668-31.461-0.005c-8.673-8.675-8.673-22.791-0.001-31.465L55.98,75.21 c8.675-8.674,22.789-8.674,31.462,0L98.05,64.604c-14.524-14.523-38.154-14.524-52.676,0L10.89,99.086 c-14.519,14.523-14.519,38.154,0.001,52.678c7.263,7.262,16.801,10.893,26.341,10.892c9.536,0,19.074-3.629,26.333-10.887 l0.002-0.001l22.984-22.99l-10.608-10.606L52.96,141.162z\"></path> </svg></a>AWS SDK v3</h2>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">S3Client</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> region<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AWS_REGION</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">deleteObject</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>bucket<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> fileKey<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> deleteParams <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    Bucket<span class=\"token operator\">:</span> bucket<span class=\"token punctuation\">,</span>\n    Key<span class=\"token operator\">:</span> fileKey<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> listVersionsCommand <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ListObjectVersionsCommand</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    Bucket<span class=\"token operator\">:</span> bucket<span class=\"token punctuation\">,</span>\n    Prefix<span class=\"token operator\">:</span> fileKey<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>listVersionsCommand<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token operator\">?.</span>Versions<span class=\"token operator\">?.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> version <span class=\"token keyword\">of</span> response<span class=\"token punctuation\">.</span>Versions<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> deleteVersionCommand <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DeleteObjectCommand</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>deleteParams<span class=\"token punctuation\">,</span>\n        VersionId<span class=\"token operator\">:</span> version<span class=\"token punctuation\">.</span>VersionId<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>deleteVersionCommand<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> deleteCommand <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DeleteObjectCommand</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>deleteParams<span class=\"token punctuation\">,</span>\n    VersionId<span class=\"token operator\">:</span> <span class=\"token string\">'null'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>deleteCommand<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Thanks for reading the post. I hope this was helpful to you.</p>","timeToRead":2,"excerpt":"Recently, I was working on a feature where we needed to delete some files from S3. I followed some instructions from AWS SDK documentation…","frontmatter":{"title":"Completely Delete Objects From Versioned S3 Bucket","publishedAt":"2024-01-07","tags":["aws","s3"],"slug":"completely-delete-objects-from-versioned-s-3-bucket"},"fields":{"slug":"/2024/01/07/completely-delete-objects-from-versioned-s-3-bucket/"}}},"pageContext":{"slug":"/2024/01/07/completely-delete-objects-from-versioned-s-3-bucket/","prev":{"frontmatter":{"tags":["API","javascript"],"title":"How To Generate API Key And Secret To Protect API"},"fields":{"slug":"/2021/09/22/how-to-generate-api-key-and-secret-to-protect-api/"}},"next":{"frontmatter":{"tags":["react","redux","my notes"],"title":"My Personal Notes On Redux And RTK"},"fields":{"slug":"/2021/11/02/my-personal-notes-on-redux-and-rtk/"}}}},"staticQueryHashes":["1066969672","1349029593","2767800352","3803536959","3825412538","3941996707","4259536812"]}